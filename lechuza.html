<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lechuza vs Águilas</title>
<style>
  :root { color-scheme: dark; }
  html, body { margin:0; height:100%; background:#000; }
  canvas { display:block; margin:auto; background:#000; border:2px solid #fff; image-rendering: pixelated; }
  #hud {
    position: fixed; inset: 0 0 auto 0; display:flex; gap:16px; 
    justify-content:center; align-items:center; color:#fff; font: 14px/1.3 system-ui,Segoe UI,Arial;
    pointer-events:none; padding:6px 8px;
  }
  #help {
    position: fixed; inset: auto 0 8px 0; text-align:center; color:#aaa; font: 12px system-ui;
    pointer-events:none;
  }
</style>
</head>
<body>
<canvas id="game" width="640" height="480" aria-label="Juego Lechuza vs Águilas"></canvas>
<div id="hud"></div>
<div id="help">← → mover • ESPACIO disparar • P pausa • M silenciar • Clic/tecla para activar audio</div>
<script>
/* ====== Config ====== */
const W = 640, H = 480;
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const hud = document.getElementById('hud');

const player = { x: W/2, y: H-50, w: 36, h: 28, speed: 5, cooldown: 0, lives: 3, inv: 0 };
const bullets = [];     // {x,y,v,from:'player'|'enemy'}
const enemies = [];     // {x,y,w,h,alive:true}
const particles = [];   // explosiones
const stars = [];       // fondo

let left=false, right=false, fire=false;
let enemyDir = 1;
let enemyStepDown = false;
let enemySpeed = 0.6;
let enemyShootTimer = 0;
let score = 0;
let level = 1;
let paused = false;
let gameover = false;
let muted = false;

/* ====== Audio (WebAudio, sin archivos) ====== */
let AC = null;
function ensureAudio() {
  if (!AC) {
    AC = new (window.AudioContext || window.webkitAudioContext)();
  }
}
function beep({freq=440, dur=0.08, type='square', vol=0.03}) {
  if (muted || !AC) return;
  const o = AC.createOscillator();
  const g = AC.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.value = vol;
  o.connect(g).connect(AC.destination);
  const t = AC.currentTime;
  o.start(t);
  o.stop(t + dur);
}
function shootSfx()   { beep({freq:760, dur:0.05, type:'square', vol:0.04}); }
function hitSfx()     { beep({freq:220, dur:0.07, type:'sawtooth', vol:0.05}); }
function loseLifeSfx(){ beep({freq:140, dur:0.2, type:'triangle', vol:0.05}); }
function winSfx()     { beep({freq:880, dur:0.18, type:'square', vol:0.06}); }

/* ====== Util ====== */
function rnd(a,b){ return a + Math.random()*(b-a); }
function rect(a,b,c,d){ ctx.fillRect(a,b,c,d); }
function coll(a,b){
  return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
}

/* ====== Arte simple (texto/emoji y shapes) ====== */
function drawOwl(x,y,w,h){
  // cuerpo
  ctx.fillStyle = '#caa46a';
  rect(x, y, w, h);
  // ojos
  ctx.fillStyle = '#fff';
  rect(x+6, y+6, 8, 8); rect(x+w-14, y+6, 8, 8);
  ctx.fillStyle = '#222';
  rect(x+9, y+9, 3, 3); rect(x+w-11, y+9, 3, 3);
  // pico
  ctx.fillStyle = '#f5d76e';
  rect(x+w/2-2, y+13, 4, 5);
  // alas
  ctx.fillStyle='#b18450';
  rect(x-4, y+6, 6, h-8);
  rect(x+w-2, y+6, 6, h-8);
}
function drawEagle(x,y,w,h){
  ctx.fillStyle = '#6f7c8c';
  rect(x, y, w, h);
  ctx.fillStyle = '#f1f2f6';
  rect(x+4, y, w-8, 6); // cabeza blanca
  ctx.fillStyle = '#222';
  rect(x+w-10, y+2, 3, 3); // ojo
  ctx.fillStyle = '#f6b93b';
  rect(x+w-6, y+3, 4, 3); // pico
  // alas
  ctx.fillStyle = '#55616e';
  rect(x-3, y+6, 6, h-10);
  rect(x+w-3, y+6, 6, h-10);
}

/* ====== Fondo estrellado ====== */
for(let i=0;i<120;i++){ stars.push({x:rnd(0,W), y:rnd(0,H), s: Math.random()<0.85 ? 1 : 2, v: rnd(0.1,0.6)}); }
function drawStars(){
  ctx.fillStyle='#000'; rect(0,0,W,H);
  ctx.fillStyle='#fff';
  for (const s of stars){
    rect(s.x, s.y, s.s, s.s);
    s.y += s.v; if (s.y > H) { s.y = -2; s.x = rnd(0,W); }
  }
}

/* ====== Partículas ====== */
function spawnExplosion(x,y,color='#ffd166'){
  for (let i=0;i<14;i++){
    particles.push({x,y, vx:rnd(-2,2), vy:rnd(-2,2), life: rnd(18,28), c:color});
  }
}
function drawParticles(){
  for (const p of particles){
    ctx.fillStyle = p.c;
    rect(p.x, p.y, 2, 2);
    p.x += p.vx; p.y += p.vy; p.life--;
  }
  for (let i=particles.length-1;i>=0;i--) if (particles[i].life<=0) particles.splice(i,1);
}

/* ====== Oleadas de águilas ====== */
function setupWave(){
  enemies.length = 0;
  const rows = 4 + Math.min(level-1, 2);
  const cols = 8;
  const gapX = 12, gapY = 14;
  const ew=34, eh=26;
  const offsetX = (W - (cols*ew + (cols-1)*gapX)) / 2;
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      enemies.push({ x: offsetX + c*(ew+gapX), y: 60 + r*(eh+gapY), w: ew, h: eh, alive:true });
    }
  }
  enemyDir = 1;
  enemySpeed = 0.5 + level*0.1;
  enemyShootTimer = 60;
}
setupWave();

/* ====== Input ====== */
addEventListener('keydown', (e)=>{
  if(!AC){ ensureAudio(); AC.resume?.(); }
  if (e.key==='ArrowLeft') left=true;
  if (e.key==='ArrowRight') right=true;
  if (e.key===' ') fire=true;
  if (e.key==='p' || e.key==='P') paused = !paused;
  if (e.key==='m' || e.key==='M') muted = !muted;
  if (gameover && (e.key===' ' || e.key==='Enter')) restart();
});
addEventListener('keyup', (e)=>{
  if (e.key==='ArrowLeft') left=false;
  if (e.key==='ArrowRight') right=false;
  if (e.key===' ') fire=false;
});
addEventListener('pointerdown', ()=>{
  if(!AC){ ensureAudio(); AC.resume?.(); }
});

/* ====== Lógica ====== */
function shoot(from, x, y, v){
  bullets.push({x, y, v, from});
  if (from==='player') shootSfx();
}
function update(){
  if (paused || gameover) return;
  // jugador
  if (left)  player.x -= player.speed;
  if (right) player.x += player.speed;
  player.x = Math.max(8, Math.min(W-8-player.w, player.x));
  if (player.cooldown>0) player.cooldown--;
  if (fire && player.cooldown===0){
    shoot('player', player.x + player.w/2 - 1.5, player.y-6, -7);
    player.cooldown = 10;
  }
  if (player.inv>0) player.inv--;

  // mover águilas
  let minX = 1e9, maxX = -1e9;
  for (const e of enemies){
    if (!e.alive) continue;
    e.x += enemySpeed * enemyDir;
    minX = Math.min(minX, e.x);
    maxX = Math.max(maxX, e.x + e.w);
  }
  if (maxX>=W-8 || minX<=8) {
    enemyDir *= -1;
    enemyStepDown = true;
  }
  if (enemyStepDown){
    for (const e of enemies) if (e.alive) e.y += 12;
    enemyStepDown = false;
  }

  // disparo enemigo (elige "tiradores" de la fila más baja por columna)
  if (--enemyShootTimer<=0){
    enemyShootTimer = Math.max(22, 60 - level*6);
    const byCol = new Map();
    for (const e of enemies){
      if (!e.alive) continue;
      const col = Math.round(e.x/50);
      const prev = byCol.get(col);
      if (!prev || e.y>prev.y) byCol.set(col,e);
    }
    const opts = [...byCol.values()];
    if (opts.length){
      const shooter = opts[(Math.random()*opts.length)|0];
      shoot('enemy', shooter.x + shooter.w/2 - 2, shooter.y + shooter.h + 2, 3.3 + Math.random()*1.2);
    }
  }

  // mover balas
  for (const b of bullets){ b.y += b.v; }
  for (let i=bullets.length-1;i>=0;i--){
    if (bullets[i].y < -16 || bullets[i].y > H+16) bullets.splice(i,1);
  }

  // colisiones: balas del jugador con águilas
  for (let i=bullets.length-1;i>=0;i--){
    const b = bullets[i]; if (b.from!=='player') continue;
    for (const e of enemies){
      if (!e.alive) continue;
      if (b.x < e.x + e.w && b.x+4 > e.x && b.y < e.y + e.h && b.y+8 > e.y){
        e.alive = false;
        bullets.splice(i,1);
        score += 10;
        spawnExplosion(e.x+e.w/2, e.y+e.h/2, '#ffd166');
        hitSfx();
        break;
      }
    }
  }
  // colisiones: balas enemigas con jugador
  for (let i=bullets.length-1;i>=0;i--){
    const b = bullets[i]; if (b.from!=='enemy') continue;
    if (b.x < player.x + player.w && b.x+4 > player.x && b.y < player.y + player.h && b.y+8 > player.y){
      bullets.splice(i,1);
      if (player.inv<=0){
        player.lives--;
        player.inv = 90;
        spawnExplosion(player.x+player.w/2, player.y+player.h/2, '#ff6b6b');
        loseLifeSfx();
        if (player.lives<=0){ gameover = true; }
      }
    }
  }

  // perder si alguna águila llega muy abajo
  for (const e of enemies){
    if (e.alive && e.y + e.h >= H-70){ gameover = true; }
  }

  // ganar oleada
  if (enemies.every(e=>!e.alive)){
    level++; score += 100;
    winSfx();
    setupWave();
  }
}

/* ====== Render ====== */
function draw(){
  drawStars();
  // HUD
  hud.textContent = `Puntos: ${score}    Vidas: ${player.lives}    Nivel: ${level}    ${muted?'(silenciado)':''} ${paused?'(pausa)':''}`;

  // jugador
  if (player.inv>0 && (player.inv>>2)%2===0){
    // parpadeo de invulnerabilidad
  } else {
    ctx.save();
    drawOwl(player.x, player.y, player.w, player.h);
    ctx.restore();
  }

  // águilas
  for (const e of enemies) if (e.alive) drawEagle(e.x, e.y, e.w, e.h);

  // balas
  ctx.fillStyle = '#ffe66d';
  for (const b of bullets) {
    ctx.fillStyle = (b.from==='player') ? '#ffe66d' : '#ff6b6b';
    rect(b.x, b.y, 4, 8);
  }

  // partículas
  drawParticles();

  if (gameover){
    ctx.fillStyle = 'rgba(0,0,0,0.6)'; rect(0,0,W,H);
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 32px system-ui, Segoe UI, Arial';
    ctx.textAlign = 'center';
    ctx.fillText('¡Juego Terminado!', W/2, H/2 - 10);
    ctx.font = '16px system-ui, Segoe UI, Arial';
    ctx.fillText('Presiona ESPACIO o ENTER para reiniciar', W/2, H/2 + 22);
  }
}

/* ====== Bucle ====== */
function loop(){
  requestAnimationFrame(loop);
  if (!paused) update();
  draw();
}
loop();

function restart(){
  score=0; level=1; gameover=false; player.lives=3; player.inv=0; player.x=W/2;
  bullets.length=0; particles.length=0; setupWave();
}
</script>
</body>
</html>
